---
import Layout from '~/layouts/PageLayout.astro';
import LocalDevMenu from '~/components/biolink/LocalDevMenu.astro';
import QRCodeDisplay from '~/components/qrcodes/QRCodeDisplay.astro';
import QrCodeSettings from '~/components/qrcodes/QrCodeSettings.astro';
import fs from 'node:fs';
import yaml from 'js-yaml';
// Import data from JSON and YAML files
import bioLinkData from '~/data/biolink.json';
const qrSettings = yaml.load(fs.readFileSync('./src/data/qr-code-settings.yaml', 'utf8'));

// Preset theme resolution with override support
// Find matching preset theme by name, or use defaults if preset is "false" or invalid
const selectedPreset = qrSettings.qrCode.preset !== "false" && qrSettings.qrCode.preset
  ? qrSettings.availableStyles.presetThemes.find(theme => theme.name === qrSettings.qrCode.preset)
  : null;

// Override system: manual overrides → preset values → hardcoded defaults
const finalDotsColor = qrSettings.qrCode.dotsColor ?? selectedPreset?.dotsColor ?? '#000000';
const finalBackgroundColor = qrSettings.qrCode.backgroundColor ?? selectedPreset?.backgroundColor ?? '#ffffff';
const finalDotsStyle = qrSettings.qrCode.dotsStyle ?? selectedPreset?.dotsStyle ?? 'square';
const finalCornerSquareOptions = qrSettings.qrCode.cornerSquareOptions ?? selectedPreset?.cornerSquareOptions ?? { color: '#000000', type: 'square' };
const finalCornerDotOptions = qrSettings.qrCode.cornerDotOptions ?? selectedPreset?.cornerDotOptions ?? { color: '#000000', type: 'square' };

const metadata = {
  title: qrSettings.pageSettings.title,
  description: qrSettings.pageSettings.description,
  ignoreTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  <div class="w-full flex flex-col items-center pb-8 bg-theme-primary">
    <!-- Mobile: vertical stack, Desktop: bento grid -->
    <div class="w-full max-w-lg lg:max-w-6xl mx-auto p-4">

      <!-- Mobile layout: vertical stack -->
      <div id="mobile-version" class="lg:hidden space-y-8">
        <!-- Page Header -->
        <div class="flex flex-col items-center text-center px-4 pb-6 pt-6 neo-container">
          <h1 class="text-3xl font-bold font-heading leading-relaxed mb-2" style="color: var(--biolink-body-text-color)">
            {qrSettings.pageSettings.title}
          </h1>
          <p class="text-sm font-mono font-semibold tracking-tight max-w-sm mx-auto" style="color: var(--biolink-muted-text-color); text-wrap: balance;">
            {qrSettings.pageSettings.description}
          </p>
        </div>

        <!-- QR Controls Section - Mobile -->
        <div class="neo-container p-6">
          <h2 class="text-xl font-bold font-heading mb-4 tracking-tight text-center" style="color: var(--biolink-accent-text-color);">
            QR Code Settings
          </h2>
          <p>Edit settings in `src\data\qr-code-settings.yaml`</p>
          <QrCodeSettings
            qrSettings={qrSettings}
            resolvedValues={{
              preset: qrSettings.qrCode.preset,
              dotsColor: finalDotsColor,
              backgroundColor: finalBackgroundColor,
              dotsStyle: finalDotsStyle,
              cornerSquareOptions: finalCornerSquareOptions,
              cornerDotOptions: finalCornerDotOptions
            }}
          />
        </div>

        <!-- QR Preview Section - Mobile -->
        <div class="neo-container p-6">
          <h2 class="text-xl font-bold font-heading mb-4 tracking-tight text-center" style="color: var(--biolink-accent-text-color);">
            QR Code Preview
          </h2>
          
        </div>
      </div>

      <!-- Desktop layout: bento grid -->
      <div id="desktop-version" class="hidden lg:grid lg:grid-cols-3 lg:gap-6">
        <!-- Page Header - Full Width -->
        <div class="lg:col-span-3 mb-6">
          <div class="flex flex-col items-center text-center px-4 pb-6 pt-6 neo-container">
            <h1 class="text-4xl font-bold font-heading leading-relaxed mb-2" style="color: var(--biolink-body-text-color)">
              {qrSettings.pageSettings.title}
            </h1>
            <p class="text-base font-mono font-semibold tracking-tight max-w-md mx-auto" style="color: var(--biolink-muted-text-color); text-wrap: balance;">
              {qrSettings.pageSettings.description}
            </p>
          </div>
        </div>

        <!-- Left section - QR Controls (1 column) -->
        <div class="lg:col-span-1">
          <div class="neo-container p-6">
            <h2 class="text-xl font-bold font-heading mb-4 tracking-tight text-center" style="color: var(--biolink-accent-text-color);">
              QR Code Settings
            </h2>
            <p class="text-sm font-mono font-semibold tracking-tight" style="color: var(--biolink-muted-text-color);">
              Edit settings in <code>src\data\qr-code-settings.yaml</code>
            <QrCodeSettings
              qrSettings={qrSettings}
              resolvedValues={{
                preset: qrSettings.qrCode.preset,
                dotsColor: finalDotsColor,
                backgroundColor: finalBackgroundColor,
                dotsStyle: finalDotsStyle,
                cornerSquareOptions: finalCornerSquareOptions,
                cornerDotOptions: finalCornerDotOptions
            }}
          />
          </div>
        </div>

        <!-- Right section - QR Preview (2 columns) -->
        <div class="lg:col-span-2">
          <div class="neo-container p-6">
            <h2 class="text-xl font-bold font-heading mb-4 tracking-tight text-center" style="color: var(--biolink-accent-text-color);">
              QR Code Preview
            </h2>
            <QRCodeDisplay
              url={bioLinkData.liveUrl}
              size={qrSettings.qrCode.size}
              dotsColor={finalDotsColor}
              dotsStyle={finalDotsStyle}
              backgroundColor={finalBackgroundColor}
              logoImage={qrSettings.qrCode.logoImage}
              cornerSquareOptions={finalCornerSquareOptions}
              cornerDotOptions={finalCornerDotOptions}
              defaultDownloadFormat={qrSettings.qrCode.defaultDownloadFormat}
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer with subtle VHS-inspired design -->
  <div class="w-full text-center py-4 text-sm text-theme-text border-t border-theme-text">
    <p>Anti-Copyright {new Date().getFullYear()} - No Rights Reserved</p>
    <p>Open Source & Free To Use - Download your own copy and customize it for yourself.</p>
  </div>

  <!-- Development-only floating menu -->
  <LocalDevMenu />


</Layout>